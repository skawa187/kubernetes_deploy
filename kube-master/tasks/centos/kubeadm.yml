---
# - name: Ensure opened ports
#   firewalld:
#     port: "{{ item }}/tcp"
#     permanent: yes
#     state: enabled
#   loop: "{{ kubernetes_master_ports.tcp }}"

# - name: Add kubernetes repo
#   yum_repository:
#     name: Kubernetes
#     description: Kubernetes repository
#     baseurl: "{{ kubernetes_repo_url }}"
#     gpgkey: "{{ kubernetes_repo_gpg }}"
#     gpgcheck: yes
#     state: present

# - name: Set SELinux to permissive mode
#   selinux:
#     state: disabled

# - name: Install kubernetes packages
#   yum:
#     name: "{{ kubernetes_packages }}"
#     state: present

# - name: Enable kubelet service
#   service:
#     name: kubelet
#     enabled: yes
#     args: --now
#   notify: Restart kubelet service CentOS

# - name: Load br_netfilter module
#   modprobe:
#     name: br_netfilter
#     state: present

- name: Ensure net.bridge.bridge-nf-call-iptables is set to 1
  lineinfile:
    path: /etc/sysctl.d/k8s.conf
    regexp: "{{ item[0] }}"
    line: "{{ item[1] }}"
  register: lineinfile_result
  loop:
    - ['^net\.bridge\.bridge-nf-call-ip6tables', 'net.bridge.bridge-nf-call-ip6tables = 1']
    - ['^net\.bridge\.bridge-nf-call-iptables', 'net.bridge.bridge-nf-call-iptables = 1']

- name: Run sysctl --system command - reload config
  command: sysctl --system
  when: lineinfile_result.changed